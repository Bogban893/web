# Тестирование Яндекс OAuth авторизации

## Что было сделано:

✅ **Интеграция Яндекс OAuth 2.0**
- Добавлена реальная авторизация через Яндекс (а не mock)
- Создан маршрут `/auth/yandex` для инициации авторизации
- Создан callback маршрут `/auth/yandex/callback` для обработки ответа

✅ **Получение информации пользователя**
- Автоматически загружается **имя пользователя** из профиля Яндекса
- Автоматически загружается **аватар** (портрет) пользователя
- Автоматически загружается **email** пользователя

✅ **Отображение в комментариях**
- Аватар отображается в каждом комментарии
- Имя пользователя отображается под аватаром
- Поддержка как локальных аватаров так и URL с Яндекс сервера

✅ **Сохранение данных**
- При первом входе создается новый пользователь с данными Яндекса
- При повторном входе обновляются данные профиля
- Все данные сохраняются в SQLite БД

## Переменные окружения

В файле `.env` установлены следующие значения:

```
YANDEX_CLIENT_ID=7b0a5de737a749e899019eeec3049478
YANDEX_CLIENT_SECRET=1d82f92645e84e799909e0c948167c5f
YANDEX_REDIRECT_URI=http://localhost:5000/auth/yandex/callback
```

## Тестирование

### Шаг 1: Перейти на страницу авторизации
```
http://localhost:5000/social_login
```

### Шаг 2: Нажать на кнопку "Войти через Яндекс"
- Вы будете перенаправлены на oauth.yandex.ru
- Введите свои учетные данные Яндекса
- Разрешите доступ приложению к вашему профилю

### Шаг 3: Вы будете перенаправлены обратно на приложение
- Будет создана сессия
- Вы будете перенаправлены на страницу `/comments`

### Шаг 4: Добавить комментарий
- Введите текст комментария в форму
- Нажмите "Отправить комментарий"
- Комментарий будет добавлен с вашим профилем:
  - Ваш аватар из Яндекса
  - Ваше имя из Яндекса
  - Время добавления комментария

### Шаг 5: Удалить комментарий
- Вы сможете удалить только свои комментарии
- Нажмите кнопку "Удалить" рядом с комментарием
- Подтвердите удаление

## Технические детали

### Поток OAuth авторизации:

1. **Инициация** (`/auth/yandex`):
   - Пользователь нажимает кнопку "Войти через Яндекс"
   - Перенаправление на `https://oauth.yandex.com/authorize`
   - Параметры запроса содержат client_id, redirect_uri и state

2. **Авторизация на Яндексе**:
   - Пользователь вводит учетные данные
   - Пользователь разрешает доступ к профилю
   - Яндекс возвращает код авторизации

3. **Callback обработка** (`/auth/yandex/callback`):
   - Приложение получает код авторизации
   - Приложение обменивает код на access token
   - Приложение получает информацию пользователя по токену

4. **Создание/Обновление пользователя**:
   - Проверяется наличие пользователя в БД по `yandex_id`
   - Если нет - создается новый пользователь
   - Если есть - обновляются данные (имя, email, аватар)
   - Создается сессия пользователя

5. **Перенаправление**:
   - Пользователь перенаправляется на `/comments`
   - Отображается сообщение об успешном входе

### Сохраняемые данные:

```python
User(
    id,                  # ID в БД
    nickname,            # Имя из профиля Яндекса
    email,              # Email из профиля Яндекса
    yandex_id,          # ID Яндекса
    avatar,             # URL аватара с Яндекс сервера
    created_at          # Время создания
)
```

## Обработка ошибок

### Если авторизация не пройдет:
1. **"Ошибка авторизации: код не получен"** - Яндекс не вернул код
2. **"Ошибка получения токена доступа"** - Проверьте CLIENT_ID и CLIENT_SECRET
3. **"Ошибка при авторизации через Яндекс"** - Проверьте интернет соединение

## Производство (Production)

Перед развертыванием на production сервер:

1. ✅ Изменить `YANDEX_REDIRECT_URI` на реальный URL сервера:
   ```
   YANDEX_REDIRECT_URI=https://yourdomain.com/auth/yandex/callback
   ```

2. ✅ Обновить SECRET_KEY в `.env`:
   ```
   SECRET_KEY=your-secure-random-key-here
   ```

3. ✅ Использовать WSGI сервер (gunicorn, uWSGI):
   ```bash
   gunicorn -w 4 -b 0.0.0.0:5000 run:app
   ```

4. ✅ Включить SSL/HTTPS

5. ✅ Добавить в Яндекс консоль правильный redirect URI

## Возможные улучшения

- [ ] Сохранение refresh token для долгосрочного доступа
- [ ] Синхронизация профиля при каждом входе
- [ ] Поддержка других провайдеров авторизации (Google, GitHub)
- [ ] Двухфакторная авторизация
- [ ] Профиль пользователя с возможностью редактирования данных
