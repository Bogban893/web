<!-- comments_section.html -->
<div class="comments-container" id="comments-section">
    <div class="comments-header">
        <h3><i class="fas fa-comments"></i> Комментарии ({{ comments|length }})</h3>
        <div class="comments-stats">
            {% if comments %}
            <span class="stat"><i class="fas fa-users"></i> {{ comments|length }} участников</span>
            <span class="stat"><i class="far fa-clock"></i> Последний {{ comments[-1].created_at.strftime('%H:%M')
                }}</span>
            {% endif %}
        </div>
    </div>

    <!-- СПИСОК КОММЕНТАРИЕВ -->
    <div class="comments-list-wrapper">
        <div class="comments-list">
            {% if comments %}
            {% for comment in comments %}
            <div class="comment-card fade-in" id="comment-{{ comment.id }}">
                <div class="comment-header">
                    <div class="comment-author-info">
                        <!-- Аватар -->
                        <div class="avatar-wrapper">
                            {% if comment.author.avatar %}
                            {% if comment.author.avatar.startswith('http') or comment.author.avatar.startswith('/') %}
                            <img src="{{ comment.author.avatar }}" alt="{{ comment.author.nickname }}" class="avatar">
                            {% else %}
                            <img src="{{ url_for('static', filename='images/' + comment.author.avatar) }}"
                                alt="{{ comment.author.nickname }}" class="avatar">
                            {% endif %}
                            {% else %}
                            <div class="avatar-default" style="background: linear-gradient(135deg, #4a90e2, #8a2be2);">
                                <i class="fas fa-user"></i>
                            </div>
                            {% endif %}
                            <div class="online-indicator"></div>
                        </div>

                        <!-- Информация об авторе -->
                        <div class="author-details">
                            <div class="author-name">
                                {{ comment.author.nickname }}
                                {% if session.user_id == comment.user_id %}
                                <span class="you-badge">Вы</span>
                                {% endif %}
                            </div>
                            <div class="comment-meta">
                                <span class="comment-time">{{ comment.created_at.strftime('%d.%m.%Y') }}</span>
                                <span class="comment-time-separator">•</span>
                                <span class="comment-time">{{ comment.created_at.strftime('%H:%M') }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Действия -->
                    <div class="comment-actions">
                        {% if session.user_id == comment.user_id %}
                        <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST"
                            class="delete-form">
                            <button type="submit" class="action-btn delete-btn"
                                onclick="return confirm('Удалить комментарий?')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                        {% endif %}
                        <!-- Кнопка админа для удаления (скрыта, видна только в режиме админа) -->
                        <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST"
                            class="delete-form admin-delete-form" style="display: none;">
                            <input type="hidden" name="admin_mode" value="true">
                            <button type="submit" class="action-btn delete-btn"
                                onclick="return confirm('Удалить комментарий (режим админа)?')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                        <!-- reply button removed per UX request -->
                    </div>
                </div>

                <!-- Текст комментария -->
                <div class="comment-body">
                    <p>{{ comment.text }}</p>
                </div>

                <!-- Дополнительная информация -->
                <div class="comment-footer">
                    {# Определяем, поставил ли текущий пользователь лайк #}
                    {% set liked = False %}
                    {% if session.user_id %}
                    {% for _l in comment.likes %}
                    {% if _l.user_id == session.user_id %}
                    {% set liked = True %}
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                    <button class="like-btn {% if liked %}liked{% endif %}" onclick="toggleLike({{ comment.id }})">
                        <i class="{{ 'fas' if liked else 'far' }} fa-heart"></i>
                        <span class="like-count" data-comment-id="{{ comment.id }}">{{ comment.likes|length }}</span>
                    </button>
                    <button class="toggle-replies-btn" onclick="toggleReplies({{ comment.id }})">
                        <i class="fas fa-comments"></i> <span class="replies-count"
                            data-comment-id="{{ comment.id }}">0</span>
                    </button>
                </div>

                <!-- Раздел ответов (скрытый по умолчанию) -->
                <div class="replies-section" id="replies-{{ comment.id }}" style="display: none;">
                    <div class="replies-container" id="replies-list-{{ comment.id }}">
                        <!-- Ответы будут загружены здесь через JS -->
                    </div>

                    {% if session.user_id %}
                    <!-- Форма добавления ответа -->
                    <div class="reply-form-container">
                        <form class="reply-form" onsubmit="submitReply(event, {{ comment.id }})">
                            <textarea name="text" placeholder="Напишите ответ..." rows="2" required></textarea>
                            <button type="submit" class="btn-primary btn-small">Ответить</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- Состояние "нет комментариев" -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="far fa-comment-dots"></i>
                </div>
                <h4>Пока нет комментариев</h4>
                <p>Будьте первым, кто оставит комментарий!</p>
            </div>
            {% endif %}
        </div>

        <!-- Индикатор загрузки (для AJAX) -->
        <div class="loading-indicator" id="comments-loading">
            <div class="spinner"></div>
            <span>Загрузка комментариев...</span>
        </div>
    </div>

    <!-- РАЗДЕЛИТЕЛЬ -->
    <div class="section-divider">
        <div class="divider-line"></div>
        <div class="divider-text">
            <i class="fas fa-pen-fancy"></i> НАПИСАТЬ КОММЕНТАРИЙ
        </div>
        <div class="divider-line"></div>
    </div>

    <!-- ФОРМА ДЛЯ ДОБАВЛЕНИЯ КОММЕНТАРИЯ -->
    <div class="comment-form-container slide-up">
        {% if session.user_id %}
        <div class="form-header">
            <h4><i class="fas fa-edit"></i> Новый комментарий</h4>
            <div class="form-tips">
                <span class="tip"><i class="fas fa-lightbulb"></i> Будьте вежливы и конструктивны</span>
            </div>
        </div>

        <form action="{{ url_for('add_comment') }}" method="POST" class="comment-form" id="commentForm">
            <input type="hidden" name="page" value="comments">

            <!-- Поле ответа -->
            <div class="reply-preview" id="replyPreview">
                <span class="reply-to"></span>
                <button type="button" class="close-reply" onclick="cancelReply()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Основное поле ввода -->
            <div class="textarea-wrapper">
                <textarea name="text" placeholder="Напишите ваш комментарий здесь..." rows="4" required
                    oninput="autoResize(this)" id="commentTextarea"></textarea>
            </div>

            <!-- Кнопки отправки -->
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="clearForm()">
                    <i class="fas fa-eraser"></i> Очистить
                </button>
                <button type="submit" class="btn-primary submit-btn">
                    <i class="fas fa-paper-plane"></i> Отправить комментарий
                </button>
            </div>
        </form>
        {% else %}
        <!-- Сообщение для неавторизованных пользователей -->
        <div class="auth-prompt">
            <div class="auth-icon">
                <i class="fas fa-lock"></i>
            </div>
            <div class="auth-content">
                <h4>Требуется авторизация</h4>
                <p>Чтобы оставлять комментарии, пожалуйста, войдите через социальные сети</p>

                <div class="social-auth-buttons">
                    <a href="{{ url_for('social_login', provider='yandex') }}" class="social-btn yandex">
                        <i class="fab fa-yandex"></i> Яндекс
                    </a>
                    <a href="{{ url_for('social_login', provider='telegram') }}" class="social-btn telegram">
                        <i class="fab fa-telegram"></i> Telegram
                    </a>
                </div>

                <div class="auth-note">
                    <i class="fas fa-shield-alt"></i>
                    <span>Мы не храним пароли, используется безопасная авторизация</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Кнопка "Наверх" для мобильных -->
<div class="scroll-top-btn" onclick="scrollToComments()">
    <i class="fas fa-arrow-up"></i>
</div>

<script>
    // Функция для переключения лайка
    function toggleLike(commentId) {
        {% if session.user_id %}
        fetch(`/api/comment/${commentId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const likeCountElement = document.querySelector(`.like-count[data-comment-id="${commentId}"]`);
                    if (likeCountElement) {
                        likeCountElement.textContent = data.likes_count;

                        // Изменяем иконку сердца у кнопки-родителя
                        const likeBtn = likeCountElement.closest('.like-btn');
                        if (likeBtn) {
                            if (data.liked) {
                                likeBtn.classList.add('liked');
                                const icon = likeBtn.querySelector('i');
                                if (icon) { icon.classList.remove('far'); icon.classList.add('fas'); }
                            } else {
                                likeBtn.classList.remove('liked');
                                const icon = likeBtn.querySelector('i');
                                if (icon) { icon.classList.remove('fas'); icon.classList.add('far'); }
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Ошибка при добавлении лайка:', error);
                alert('Ошибка при добавлении лайка');
            });
        {% else %}
        alert('Пожалуйста, войдите для добавления лайка');
        window.location.href = '/social_login';
        {% endif %}
    }

    // Функция для переключения видимости ответов
    function toggleReplies(commentId) {
        const repliesSection = document.getElementById(`replies-${commentId}`);
        const repliesList = document.getElementById(`replies-list-${commentId}`);

        if (repliesSection.style.display === 'none') {
            repliesSection.style.display = 'block';
            loadReplies(commentId);
        } else {
            repliesSection.style.display = 'none';
        }
    }

    // Функция для загрузки ответов
    function loadReplies(commentId) {
        fetch(`/api/comment/${commentId}/replies`, { credentials: 'same-origin' })
            .then(response => response.json())
            .then(replies => {
                const repliesList = document.getElementById(`replies-list-${commentId}`);
                repliesList.innerHTML = '';

                if (replies.length === 0) {
                    repliesList.innerHTML = '<p class="no-replies">Пока нет ответов</p>';
                    return;
                }

                replies.forEach(reply => {
                    const replyEl = createReplyElement(reply);
                    repliesList.appendChild(replyEl);
                });
            })
            .catch(error => {
                console.error('Ошибка при загрузке ответов:', error);
            });
    }

    // Функция для создания элемента ответа
    function createReplyElement(reply) {
        const div = document.createElement('div');
        div.className = 'reply-item';
        div.id = `comment-${reply.id}`;

        const avatarUrl = reply.avatar.startsWith('http') || reply.avatar.startsWith('/')
            ? reply.avatar
            : `/static/images/${reply.avatar}`;

        let deleteBtn = '';
        if (reply.can_delete) {
            deleteBtn = `
            <form action="/delete_comment/${reply.id}" method="POST" class="delete-form" style="display: inline;">
                <button type="submit" class="action-btn delete-btn" onclick="return confirm('Удалить ответ?')">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </form>
        `;
        }

        div.innerHTML = `
        <div class="reply-header">
            <div class="reply-author-info">
                <img src="${avatarUrl}" alt="${reply.author}" class="avatar reply-avatar">
                <div class="author-details">
                    <div class="author-name">${reply.author}</div>
                    <div class="comment-meta">
                        <span class="comment-time">${reply.created_at}</span>
                    </div>
                </div>
            </div>
            <div class="reply-actions">
                ${deleteBtn}
            </div>
        </div>
        <div class="reply-body">
            <p>${reply.text}</p>
        </div>
        <!-- Лайки для ответов отключены (UI убран) -->
    `;

        return div;
    }

    // Проверяем режим админа при загрузке страницы комментариев
    document.addEventListener('DOMContentLoaded', function () {
        const isAdminMode = sessionStorage.getItem('isAdminMode') === 'true';
        if (isAdminMode) {
            // Показываем скрытые кнопки удаления админа
            const adminDeleteForms = document.querySelectorAll('.admin-delete-form');
            adminDeleteForms.forEach(form => {
                form.style.display = 'inline';
            });
            console.log('✅ Админ-режим: кнопки удаления активны для всех комментариев');
        }

        // Загружаем счетчики для всех комментариев
        const commentCards = document.querySelectorAll('.comment-card');
        commentCards.forEach(card => {
            const commentId = card.id.replace('comment-', '');
            if (commentId) {
                // Загружаем количество ответов
                fetch(`/api/comment/${commentId}/replies`, { credentials: 'same-origin' })
                    .then(response => response.json())
                    .then(replies => {
                        const repliesCount = document.querySelector(`.replies-count[data-comment-id="${commentId}"]`);
                        if (repliesCount) {
                            repliesCount.textContent = replies.length;
                        }
                    })
                    .catch(error => console.error('Ошибка при загрузке ответов:', error));
            }
        });
    });

    // Очистить форму комментария
    function clearForm() {
        const form = document.getElementById('commentForm');
        if (form) {
            form.reset();
        }

        // Сброс превью ответа
        const replyPreview = document.getElementById('replyPreview');
        if (replyPreview) {
            replyPreview.style.display = 'none';
            const replyTo = replyPreview.querySelector('.reply-to');
            if (replyTo) replyTo.textContent = '';
        }

        // Сброс счётчика символов
        const charCount = document.getElementById('charCount');
        if (charCount) charCount.textContent = '0/1000';

        // Вернуть фокус в поле ввода
        const textarea = document.getElementById('commentTextarea');
        if (textarea) {
            textarea.style.height = '';
            textarea.focus();
        }
    }

    // Отмена режима ответа (тот же эффект, что и кнопка закрытия превью)
    function cancelReply() {
        const replyPreview = document.getElementById('replyPreview');
        if (replyPreview) {
            replyPreview.style.display = 'none';
            const replyTo = replyPreview.querySelector('.reply-to');
            if (replyTo) replyTo.textContent = '';
        }
        const parentInput = document.querySelector('input[name="parent_id"]');
        if (parentInput) parentInput.value = '';
    }

    // Отправка ответа через AJAX
    function submitReply(event, parentId) {
        event.preventDefault();

        const form = event.target;
        const textarea = form.querySelector('textarea');
        const text = textarea.value.trim();

        if (!text) {
            alert('Ответ не может быть пустым');
            return;
        }

        const formData = new FormData();
        formData.append('text', text);
        formData.append('page', 'comments');

        fetch(`/add_reply/${parentId}`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Очищаем поле
                    textarea.value = '';
                    textarea.style.height = '';

                    // Добавляем новый ответ в список
                    const replyList = document.getElementById(`replies-list-${parentId}`);
                    if (replyList) {
                        const replyEl = createReplyElement(data.reply);

                        // Если был текст "Пока нет ответов", удаляем его
                        const noReplies = replyList.querySelector('.no-replies');
                        if (noReplies) noReplies.remove();

                        replyList.appendChild(replyEl);
                    }

                    // Обновляем счётчик ответов
                    const repliesCount = document.querySelector(`.replies-count[data-comment-id="${parentId}"]`);
                    if (repliesCount) {
                        repliesCount.textContent = parseInt(repliesCount.textContent) + 1;
                    }

                    console.log('✅ Ответ добавлен успешно');
                } else {
                    alert('Ошибка: ' + (data.error || 'Не удалось добавить ответ'));
                }
            })
            .catch(error => {
                console.error('Ошибка при добавлении ответа:', error);
                alert('Ошибка при добавлении ответа');
            });
    }

    // Автоизменение высоты textarea
    function autoResize(el) {
        if (!el) return;
        el.style.height = 'auto';
        el.style.height = (el.scrollHeight) + 'px';
        const charCount = document.getElementById('charCount');
        if (charCount) {
            const max = 1000;
            const len = el.value.length;
            charCount.textContent = `${len}/${max}`;
        }
    }
</script>