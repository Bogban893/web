<!-- comments_section.html -->
<div class="comments-container" id="comments-section">
    <div class="comments-header">
        <h3><i class="fas fa-comments"></i> Комментарии ({{ comments|length }})</h3>
        <div class="comments-stats">
            {% if comments %}
            <span class="stat"><i class="fas fa-users"></i> {{ comments|length }} участников</span>
            <span class="stat"><i class="far fa-clock"></i> Последний {{ comments[-1].created_at.strftime('%H:%M')
                }}</span>
            {% endif %}
        </div>
    </div>

    <!-- СПИСОК КОММЕНТАРИЕВ -->
    <div class="comments-list-wrapper">
        <div class="comments-list">
            {% if comments %}
            {% for comment in comments %}
            <div class="comment-card fade-in" id="comment-{{ comment.id }}">
                <div class="comment-header">
                    <div class="comment-author-info">
                        <!-- Аватар -->
                        <div class="avatar-wrapper">
                            {% if comment.author.avatar %}
                            {% if comment.author.avatar.startswith('http') or comment.author.avatar.startswith('/') %}
                            <img src="{{ comment.author.avatar }}" alt="{{ comment.author.nickname }}" class="avatar">
                            {% else %}
                            <img src="{{ url_for('static', filename='images/' + comment.author.avatar) }}"
                                alt="{{ comment.author.nickname }}" class="avatar">
                            {% endif %}
                            {% else %}
                            <div class="avatar-default" style="background: linear-gradient(135deg, #4a90e2, #8a2be2);">
                                <i class="fas fa-user"></i>
                            </div>
                            {% endif %}
                            <div class="online-indicator"></div>
                        </div>

                        <!-- Информация об авторе -->
                        <div class="author-details">
                            <div class="author-name">
                                {{ comment.author.nickname }}
                                {% if session.user_id == comment.user_id %}
                                <span class="you-badge">Вы</span>
                                {% endif %}
                            </div>
                            <div class="comment-meta">
                                <span class="comment-time">{{ comment.created_at.strftime('%d.%m.%Y') }}</span>
                                <span class="comment-time-separator">•</span>
                                <span class="comment-time">{{ comment.created_at.strftime('%H:%M') }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Действия -->
                    <div class="comment-actions">
                        {% if session.user_id == comment.user_id %}
                        <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST"
                            class="delete-form">
                            <button type="submit" class="action-btn delete-btn"
                                onclick="return confirm('Удалить комментарий?')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                        {% endif %}
                        <button class="action-btn reply-btn" onclick="replyTo('{{ comment.author.nickname }}')">
                            <i class="fas fa-reply"></i>
                        </button>
                    </div>
                </div>

                <!-- Текст комментария -->
                <div class="comment-body">
                    <p>{{ comment.text }}</p>
                </div>

                <!-- Дополнительная информация -->
                <div class="comment-footer">
                    <button class="like-btn" onclick="toggleLike({{ comment.id }})">
                        <i class="far fa-heart"></i> <span class="like-count" data-comment-id="{{ comment.id }}">0</span>
                    </button>
                    <button class="toggle-replies-btn" onclick="toggleReplies({{ comment.id }})">
                        <i class="fas fa-comments"></i> <span class="replies-count" data-comment-id="{{ comment.id }}">0</span>
                    </button>
                </div>

                <!-- Раздел ответов (скрытый по умолчанию) -->
                <div class="replies-section" id="replies-{{ comment.id }}" style="display: none;">
                    <div class="replies-container" id="replies-list-{{ comment.id }}">
                        <!-- Ответы будут загружены здесь через JS -->
                    </div>

                    {% if session.user_id %}
                    <!-- Форма добавления ответа -->
                    <div class="reply-form-container">
                        <form action="{{ url_for('add_reply', parent_id=comment.id) }}" method="POST" class="reply-form">
                            <input type="hidden" name="page" value="comments">
                            <textarea name="text" placeholder="Напишите ответ..." rows="2" required></textarea>
                            <button type="submit" class="btn-primary btn-small">Ответить</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- Состояние "нет комментариев" -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="far fa-comment-dots"></i>
                </div>
                <h4>Пока нет комментариев</h4>
                <p>Будьте первым, кто оставит комментарий!</p>
                <div class="empty-actions">
                    <button class="btn-primary" onclick="document.querySelector('textarea').focus()">
                        <i class="fas fa-pen"></i> Написать комментарий
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Индикатор загрузки (для AJAX) -->
        <div class="loading-indicator" id="comments-loading">
            <div class="spinner"></div>
            <span>Загрузка комментариев...</span>
        </div>
    </div>

    <!-- РАЗДЕЛИТЕЛЬ -->
    <div class="section-divider">
        <div class="divider-line"></div>
        <div class="divider-text">
            <i class="fas fa-pen-fancy"></i> НАПИСАТЬ КОММЕНТАРИЙ
        </div>
        <div class="divider-line"></div>
    </div>

    <!-- ФОРМА ДЛЯ ДОБАВЛЕНИЯ КОММЕНТАРИЯ -->
    <div class="comment-form-container slide-up">
        {% if session.user_id %}
        <div class="form-header">
            <h4><i class="fas fa-edit"></i> Новый комментарий</h4>
            <div class="form-tips">
                <span class="tip"><i class="fas fa-lightbulb"></i> Будьте вежливы и конструктивны</span>
            </div>
        </div>

        <form action="{{ url_for('add_comment') }}" method="POST" class="comment-form" id="commentForm">
            <input type="hidden" name="page" value="comments">

            <!-- Поле ответа -->
            <div class="reply-preview" id="replyPreview">
                <span class="reply-to"></span>
                <button type="button" class="close-reply" onclick="cancelReply()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Основное поле ввода -->
            <div class="textarea-wrapper">
                <textarea name="text" placeholder="Напишите ваш комментарий здесь..." rows="4" required
                    oninput="autoResize(this)" id="commentTextarea"></textarea>
                <div class="textarea-footer">
                    <span class="char-count" id="charCount">0/1000</span>
                    <div class="formatting-tips">
                        <span class="format-hint"><i class="fas fa-code"></i> Поддерживается Markdown</span>
                    </div>
                </div>
            </div>

            <!-- Кнопки отправки -->
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="clearForm()">
                    <i class="fas fa-eraser"></i> Очистить
                </button>
                <button type="submit" class="btn-primary submit-btn">
                    <i class="fas fa-paper-plane"></i> Отправить комментарий
                </button>
            </div>
        </form>
        {% else %}
        <!-- Сообщение для неавторизованных пользователей -->
        <div class="auth-prompt">
            <div class="auth-icon">
                <i class="fas fa-lock"></i>
            </div>
            <div class="auth-content">
                <h4>Требуется авторизация</h4>
                <p>Чтобы оставлять комментарии, пожалуйста, войдите через социальные сети</p>

                <div class="social-auth-buttons">
                    <a href="{{ url_for('social_login', provider='yandex') }}" class="social-btn yandex">
                        <i class="fab fa-yandex"></i> Яндекс
                    </a>
                    <a href="{{ url_for('social_login', provider='vk') }}" class="social-btn vk">
                        <i class="fab fa-vk"></i> VK
                    </a>
                    <a href="{{ url_for('social_login', provider='telegram') }}" class="social-btn telegram">
                        <i class="fab fa-telegram"></i> Telegram
                    </a>
                </div>

                <div class="auth-note">
                    <i class="fas fa-shield-alt"></i>
                    <span>Мы не храним пароли, используется безопасная авторизация</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Кнопка "Наверх" для мобильных -->
<div class="scroll-top-btn" onclick="scrollToComments()">
    <i class="fas fa-arrow-up"></i>
</div>

<script>
// Функция для переключения лайка
function toggleLike(commentId) {
    {% if session.user_id %}
    fetch(`/api/comment/${commentId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const likeCountElement = document.querySelector(`.like-count[data-comment-id="${commentId}"]`);
            likeCountElement.textContent = data.likes_count;
            
            // Изменяем иконку сердца
            const likeBtn = event.target.closest('.like-btn');
            if (data.liked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }
    })
    .catch(error => {
        console.error('Ошибка при добавлении лайка:', error);
        alert('Ошибка при добавлении лайка');
    });
    {% else %}
    alert('Пожалуйста, войдите для добавления лайка');
    window.location.href = '/social_login';
    {% endif %}
}

// Функция для переключения видимости ответов
function toggleReplies(commentId) {
    const repliesSection = document.getElementById(`replies-${commentId}`);
    const repliesList = document.getElementById(`replies-list-${commentId}`);
    
    if (repliesSection.style.display === 'none') {
        repliesSection.style.display = 'block';
        loadReplies(commentId);
    } else {
        repliesSection.style.display = 'none';
    }
}

// Функция для загрузки ответов
function loadReplies(commentId) {
    fetch(`/api/comment/${commentId}/replies`)
    .then(response => response.json())
    .then(replies => {
        const repliesList = document.getElementById(`replies-list-${commentId}`);
        repliesList.innerHTML = '';
        
        if (replies.length === 0) {
            repliesList.innerHTML = '<p class="no-replies">Пока нет ответов</p>';
            return;
        }
        
        replies.forEach(reply => {
            const replyEl = createReplyElement(reply);
            repliesList.appendChild(replyEl);
        });
    })
    .catch(error => {
        console.error('Ошибка при загрузке ответов:', error);
    });
}

// Функция для создания элемента ответа
function createReplyElement(reply) {
    const div = document.createElement('div');
    div.className = 'reply-item';
    div.id = `comment-${reply.id}`;
    
    const avatarUrl = reply.avatar.startsWith('http') || reply.avatar.startsWith('/') 
        ? reply.avatar 
        : `/static/images/${reply.avatar}`;
    
    let deleteBtn = '';
    if (reply.can_delete) {
        deleteBtn = `
            <form action="/delete_comment/${reply.id}" method="POST" class="delete-form" style="display: inline;">
                <button type="submit" class="action-btn delete-btn" onclick="return confirm('Удалить ответ?')">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </form>
        `;
    }
    
    div.innerHTML = `
        <div class="reply-header">
            <div class="reply-author-info">
                <img src="${avatarUrl}" alt="${reply.author}" class="avatar reply-avatar">
                <div class="author-details">
                    <div class="author-name">${reply.author}</div>
                    <div class="comment-meta">
                        <span class="comment-time">${reply.created_at}</span>
                    </div>
                </div>
            </div>
            <div class="reply-actions">
                ${deleteBtn}
            </div>
        </div>
        <div class="reply-body">
            <p>${reply.text}</p>
        </div>
        <div class="reply-footer">
            <button class="like-btn ${reply.user_liked ? 'liked' : ''}" onclick="toggleLike(${reply.id})">
                <i class="${reply.user_liked ? 'fas' : 'far'} fa-heart"></i> 
                <span class="like-count" data-comment-id="${reply.id}">${reply.likes_count}</span>
            </button>
        </div>
    `;
    
    return div;
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем счетчики для всех комментариев
    const commentCards = document.querySelectorAll('.comment-card');
    commentCards.forEach(card => {
        const commentId = card.id.replace('comment-', '');
        if (commentId) {
            // Загружаем количество ответов
            fetch(`/api/comment/${commentId}/replies`)
                .then(response => response.json())
                .then(replies => {
                    const repliesCount = document.querySelector(`.replies-count[data-comment-id="${commentId}"]`);
                    if (repliesCount) {
                        repliesCount.textContent = replies.length;
                    }
                })
                .catch(error => console.error('Ошибка при загрузке ответов:', error));
        }
    });
});
</script>